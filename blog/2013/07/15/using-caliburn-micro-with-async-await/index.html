
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Using Caliburn.Micro with async/await - valeriu caraulean</title>
  <meta name="author" content="Valeriu Caraulean">

  
  <meta name="description" content="This post will give an overview of how you can use async/await features from C# 5.0 with Caliburn.Micro (CM). If you&#8217;ve found an error or want &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://caraulean.com/blog/2013/07/15/using-caliburn-micro-with-async-await/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="valeriu caraulean" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-21974825-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1>
    <a href="/">
      <div id="logoLeft">{</div>
		<div id="wrapper">
			<div id="logoText"> valeriu caraulean </div>
			
				<div id="subtitle">keep it simple, it will work...</div>
			
		</div>
      <div id="logoRight">}</div>
    </a>
  </h1>
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:caraulean.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/projects">Projects</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Using Caliburn.Micro With Async/await</h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-07-15T11:21:00+02:00" pubdate data-updated="true">Jul 15<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>This post will give an overview of how you can use async/await features from C# 5.0 with <a href="http://caliburnmicro.codeplex.com/">Caliburn.Micro (CM)</a>. If you&#8217;ve found an error or want to complete the content please let me know in the comments. A sample application demonstrating async/await interactions in CM <a href="https://github.com/vcaraulean/CaliburnMicro.AsyncDemo">is available on GitHub</a>.</p>

<h2>Setting it up</h2>

<p>To use Tasks and async/await features you need the latest version of Caliburn.Micro. Support for Tasks was introduced in version 1.5, so you&#8217;ll need a version higher than that. And, of course, you need .NET Framework 4.5 or higher. All examples in this post were tested in a WPF application targeting .NET 4.5 framework. However, same code will be probably valid for Silverlight, WP8 and Windows8 apps.</p>

<h4>Create and configure new project to test the concepts</h4>

<ul>
<li>Create new WPF 4.5 application</li>
<li>Install Caliburn.Micro from nuget. You&#8217;d better choose the <code>Caliburn.Micro.Start</code> package as it has everything required to run a Caliburn application (boostrapper, container, main screen)</li>
<li>Change App.cs to correctly bootstrap with Caliburn, <a href="http://caliburnmicro.codeplex.com/wikipage?title=Nuget">here is how to do it</a></li>
</ul>


<h2>Async Actions</h2>

<p>The syntax for attaching actions in XAML will remain unchanged:</p>

<pre><code>&lt;Button x:Name="RunTask1Async"&gt;
&lt;Button cal:Message.Attach="RunTask1Async"&gt;
</code></pre>

<p>When declaring action&#8217;s method we can specify that we want to handle it asynchronously:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public async void RunTask1Async()
</span><span class='line'>{
</span><span class='line'>    Log("RunTask1Async - starting a 4 second task");
</span><span class='line'>    await Task.Delay(4000);
</span><span class='line'>    Log("RunTask1Async completed");
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>And that&#8217;s all you need to execute an action asynchronously (if you have to execute a Task).</p>

<h2>Async handlers for Screen events and overrides</h2>

<p>CM offers few handy methods that allow to connect to Screen&#8217;s lifetime events. Some method overrides with async signatures:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>protected override async void OnInitialize()
</span><span class='line'>{
</span><span class='line'>  Log("OnInitialize - starting a 7 seconds task");
</span><span class='line'>  await Task.Delay(7000);
</span><span class='line'>  Log("OnInitialize completed");
</span><span class='line'>}
</span><span class='line'>protected override async void OnActivate() { }
</span><span class='line'>protected override async void OnViewLoaded(object view) { }
</span><span class='line'>protected override async void OnViewAttached(object view, object context) { }
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>To note here that even if the method in base class is not marked <code>async</code>, our overrides declare them with <code>async</code> modifiers and it runs fine.</p>

<p>Similarly, you can handle Screen&#8217;s events the same way how you&#8217;re handling any .NET event in asynchronous way:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  // ...
</span><span class='line'>  ViewAttached += OnViewAttachedEventHandler;
</span><span class='line'>}
</span><span class='line'>private async void OnViewAttachedEventHandler(object sender, ViewAttachedEventArgs args)
</span><span class='line'>{
</span><span class='line'>  Log("OnViewAttachedEventHandler- starting a 1 second task");
</span><span class='line'>  await Task.Delay(1000);
</span><span class='line'>  Log("OnViewAttachedEventHandler completed");
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>IHandleWithTask interface</h2>

<p>This is a new addition to CM, declared as:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public interface IHandleWithTask&lt;TMessage&gt; : IHandle
</span><span class='line'>{
</span><span class='line'>    Task Handle(TMessage message);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>It&#8217;s extremely useful when you want to handle a particular message using a Task and off-load application&#8217;s main thread.</p>

<p>An example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class Message { }
</span><span class='line'>
</span><span class='line'>public class MessageHandler : IHandleWithTask&lt;Message&gt;
</span><span class='line'>{
</span><span class='line'>  public MessageHandler(IEventAggregator eventAggregator)
</span><span class='line'>  {
</span><span class='line'>      eventAggregator.Subscribe(this);
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  public async Task Handle(Message message)
</span><span class='line'>  {
</span><span class='line'>      await Task.Delay(3000);
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Convert coroutines to Tasks</h2>

<p>This can be done easily by using an extension method:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public async void WrapIResultInTaskAsync()
</span><span class='line'>{
</span><span class='line'>  await new SimpleCoroutine().ExecuteAsync();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>&#8220;async void&#8221; or &#8220;async Task&#8221;</h2>

<p>A great question will be: should I use <code>async void</code> or <code>async Task</code> as a return value of action methods, screen&#8217;s events and overrides? Since you can do both and the code will compile and run mostly fine, let&#8217;s see what <a href="http://blog.stephencleary.com/">Stephen Cleary</a> writes about it in <a href="http://msdn.microsoft.com/en-us/magazine/jj991977.aspx">Best Practices in Asynchronous Programming</a> article:</p>

<blockquote><p>You should prefer async Task to async void. Async Task methods enable easier error-handling, composability and testability. The exception to this guideline is asynchronous event handlers, which must return void. This exception includes methods that are logically event handlers even if theyâ€™re not literally event handlers (for example, ICommand.Execute implementations).</p></blockquote>


<p>I will join this recommendation. Actions are event handlers at their core, normally they are executed as &#8220;start and forget&#8221;. If something happens (an exception), it will be handled at application level. For the case when you want to handle any exceptions locally, you may want to create an override which returns an <code>async Task</code>. Also, this will allow calling same method action from another part of the program or write a unit test to verify an asynchronous process.</p>

<h2>References</h2>

<ul>
<li><a href="http://devlicio.us/blogs/rob_eisenberg/archive/2013/03/18/durandal-1-2-0-and-caliburn-micro-1-5-0-released.aspx">Caliburn.Micro. 1.5.0 release notes</a></li>
<li><a href="http://msdn.microsoft.com/en-us/magazine/jj991977.aspx">&#8220;Best Practices in Asynchronous Programming&#8221; by Stephen Cleary (MSDN Mag)</a></li>
<li><a href="http://marcoamendola.wordpress.com/2012/10/16/coroutines-are-dead-long-live-coroutines/">&#8220;Coroutines are dead. Long live Coroutines.&#8221; by Marco Amendola</a></li>
</ul>


<p>This is pretty much it. If you&#8217;ve found an error or may complete this post with additional info, let me know in the comments.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Valeriu Caraulean</span></span>

      








  


<time datetime="2013-07-15T11:21:00+02:00" pubdate data-updated="true">Jul 15<span>th</span>, 2013</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://caraulean.com/blog/2013/07/15/using-caliburn-micro-with-async-await/" data-via="vcaraulean" data-counturl="http://caraulean.com/blog/2013/07/15/using-caliburn-micro-with-async-await/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left articlenav" href="/blog/2012/12/14/book-review-nosql-distilled/" title="Previous Post: Book review - NoSQL Distilled">&laquo; Book review - NoSQL Distilled</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
	<h1>About</h1>
	<p>I'm a passionate software developer living in Geneva, Switzerland</p>
	<p><a href="/about">Read more ...</a></p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/07/15/using-caliburn-micro-with-async-await/">Using Caliburn.Micro with async/await</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/14/book-review-nosql-distilled/">Book review - NoSQL Distilled</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/15/do-less-and-achieve-more-with-ravendb/">Do less and achieve more with RavenDb</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/09/diving-deeper-in-reactive-extensions/">Diving deeper in Reactive Extensions, concurrency</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/30/hello/">Hello, new blog!</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/30/visual-studio-2012-dark-theme-tip/">Visual Studio 2012 dark theme tip - light up your UserControl in XAML designer</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/28/evening-time-time-for-fun/">Evening time, time for fun</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/21/on-motivation-a-quote/">On motivation, a quote...</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/19/migrating-from-silverlight-to-wpf-a-case-study/">Migrating from Silverlight to WPF, a case study</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/18/fearing-about-silverlights-future-dont/">Fearing about Silverlight's future? Don't...</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("vcaraulean", 5, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/vcaraulean" class="twitter-follow-button" data-show-count="false">Follow @vcaraulean</a>
  
</section>



<section class="googleplus googleplus-hidden">
  <h1>
    <a href="https://plus.google.com/108353347632139121774?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Valeriu Caraulean -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'caraulean';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://caraulean.com/blog/2013/07/15/using-caliburn-micro-with-async-await/';
        var disqus_url = 'http://caraulean.com/blog/2013/07/15/using-caliburn-micro-with-async-await/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
